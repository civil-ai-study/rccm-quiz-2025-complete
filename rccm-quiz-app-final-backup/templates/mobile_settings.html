{% extends "base.html" %}

{% block title %}ãƒ¢ãƒã‚¤ãƒ«è¨­å®š - RCCMè©¦é¨“å•é¡Œé›†{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-mobile-alt text-primary"></i> ãƒ¢ãƒã‚¤ãƒ«è¨­å®š</h2>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                    <i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                </a>
            </div>
        </div>
    </div>

    <!-- PWAæ©Ÿèƒ½ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card pwa-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-download"></i> PWAï¼ˆProgressive Web Appï¼‰
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h6>
                            <p class="text-muted">ã“ã®Webã‚¢ãƒ—ãƒªã‚’ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚„PCã«ã‚¢ãƒ—ãƒªã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å­¦ç¿’ã‚„é«˜é€Ÿèµ·å‹•ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</p>
                            
                            <div class="pwa-features mb-3">
                                <div class="feature-item">
                                    <i class="fas fa-check text-success"></i>
                                    <span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å­¦ç¿’å¯¾å¿œ</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check text-success"></i>
                                    <span>é«˜é€Ÿèµ·å‹•</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check text-success"></i>
                                    <span>ãƒ›ãƒ¼ãƒ ç”»é¢ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</span>
                                </div>
                                <div class="feature-item">
                                    <i class="fas fa-check text-success"></i>
                                    <span>ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆä»Šå¾Œå¯¾å¿œäºˆå®šï¼‰</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <button id="installPWABtn" class="btn btn-success btn-lg mb-3" style="display: none;">
                                <i class="fas fa-download"></i> ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
                            </button>
                            <div id="pwaStatus" class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span id="pwaStatusText">PWAå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³å£°æ©Ÿèƒ½è¨­å®š -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card voice-settings-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-volume-up"></i> éŸ³å£°èª­ã¿ä¸Šã’è¨­å®š
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="voiceEnabled" checked>
                        <label class="form-check-label" for="voiceEnabled">
                            éŸ³å£°èª­ã¿ä¸Šã’ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                        </label>
                    </div>

                    <div class="voice-controls">
                        <div class="mb-3">
                            <label for="voiceRate" class="form-label">
                                èª­ã¿ä¸Šã’é€Ÿåº¦: <span id="voiceRateValue">1.0</span>
                            </label>
                            <input type="range" class="form-range" id="voiceRate" 
                                   min="0.5" max="2.0" step="0.1" value="1.0">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">é…ã„</small>
                                <small class="text-muted">é€Ÿã„</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="voicePitch" class="form-label">
                                éŸ³ã®é«˜ã•: <span id="voicePitchValue">1.0</span>
                            </label>
                            <input type="range" class="form-range" id="voicePitch" 
                                   min="0.5" max="2.0" step="0.1" value="1.0">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">ä½ã„</small>
                                <small class="text-muted">é«˜ã„</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="voiceVolume" class="form-label">
                                éŸ³é‡: <span id="voiceVolumeValue">0.8</span>
                            </label>
                            <input type="range" class="form-range" id="voiceVolume" 
                                   min="0.0" max="1.0" step="0.1" value="0.8">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">å°</small>
                                <small class="text-muted">å¤§</small>
                            </div>
                        </div>

                        <button id="testVoiceBtn" class="btn btn-outline-primary">
                            <i class="fas fa-play"></i> ãƒ†ã‚¹ãƒˆèª­ã¿ä¸Šã’
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š -->
        <div class="col-lg-6">
            <div class="card touch-settings-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-hand-pointer"></i> ã‚¿ãƒƒãƒã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼è¨­å®š
                    </h5>
                </div>
                <div class="card-body">
                    <div class="gesture-settings">
                        <div class="mb-3">
                            <label for="swipeThreshold" class="form-label">
                                ã‚¹ãƒ¯ã‚¤ãƒ—æ„Ÿåº¦: <span id="swipeThresholdValue">50</span>px
                            </label>
                            <input type="range" class="form-range" id="swipeThreshold" 
                                   min="20" max="100" step="5" value="50">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">æ•æ„Ÿ</small>
                                <small class="text-muted">éˆæ„Ÿ</small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="longPressDelay" class="form-label">
                                é•·æŠ¼ã—åˆ¤å®šæ™‚é–“: <span id="longPressDelayValue">500</span>ms
                            </label>
                            <input type="range" class="form-range" id="longPressDelay" 
                                   min="300" max="1000" step="50" value="500">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">çŸ­ã„</small>
                                <small class="text-muted">é•·ã„</small>
                            </div>
                        </div>

                        <!-- ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼èª¬æ˜ -->
                        <div class="gesture-guide">
                            <h6><i class="fas fa-info-circle"></i> åˆ©ç”¨å¯èƒ½ãªã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼</h6>
                            <div class="gesture-item">
                                <div class="gesture-icon">ğŸ‘ˆ</div>
                                <div class="gesture-desc">
                                    <strong>å·¦ã‚¹ãƒ¯ã‚¤ãƒ—</strong><br>
                                    <small>æ¬¡ã®å•é¡Œã«é€²ã‚€</small>
                                </div>
                            </div>
                            <div class="gesture-item">
                                <div class="gesture-icon">ğŸ‘‰</div>
                                <div class="gesture-desc">
                                    <strong>å³ã‚¹ãƒ¯ã‚¤ãƒ—</strong><br>
                                    <small>å‰ã®å•é¡Œã«æˆ»ã‚‹</small>
                                </div>
                            </div>
                            <div class="gesture-item">
                                <div class="gesture-icon">âœ‹</div>
                                <div class="gesture-desc">
                                    <strong>é•·æŠ¼ã—</strong><br>
                                    <small>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card offline-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-wifi-slash"></i> ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å­¦ç¿’ãƒ‡ãƒ¼ã‚¿</h6>
                            <div id="offlineStatus" class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>ä¿å­˜æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°:</span>
                                    <span id="offlineSessionCount" class="badge bg-primary">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>ä½¿ç”¨å®¹é‡:</span>
                                    <span id="offlineDataSize" class="badge bg-info">0 MB</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>æœ€çµ‚åŒæœŸ:</span>
                                    <span id="lastSyncTime" class="badge bg-secondary">æœªåŒæœŸ</span>
                                </div>
                            </div>

                            <div class="offline-controls">
                                <button id="syncOfflineBtn" class="btn btn-primary me-2">
                                    <i class="fas fa-sync"></i> ä»Šã™ãåŒæœŸ
                                </button>
                                <button id="clearOfflineBtn" class="btn btn-outline-danger">
                                    <i class="fas fa-trash"></i> ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>è‡ªå‹•åŒæœŸè¨­å®š</h6>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="autoSyncEnabled" checked>
                                <label class="form-check-label" for="autoSyncEnabled">
                                    ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«è‡ªå‹•åŒæœŸ
                                </label>
                            </div>

                            <div class="connection-status mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>ç¾åœ¨ã®æ¥ç¶šçŠ¶æ…‹:</span>
                                    <span id="connectionStatus" class="badge bg-success">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
                                </div>
                            </div>

                            <div class="offline-info">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã‚‚å­¦ç¿’ã‚’ç¶šã‘ã‚‹ã“ã¨ãŒã§ãã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¾©å¸°æ™‚ã«è‡ªå‹•çš„ã«ãƒ‡ãƒ¼ã‚¿ãŒåŒæœŸã•ã‚Œã¾ã™ã€‚
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shortcuts-card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-keyboard"></i> ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>å•é¡Œå›ç­”</h6>
                            <div class="shortcut-item">
                                <kbd>Ctrl + 1</kbd> <span>é¸æŠè‚¢A</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl + 2</kbd> <span>é¸æŠè‚¢B</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl + 3</kbd> <span>é¸æŠè‚¢C</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl + 4</kbd> <span>é¸æŠè‚¢D</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»æ©Ÿèƒ½</h6>
                            <div class="shortcut-item">
                                <kbd>Space</kbd> <span>éŸ³å£°èª­ã¿ä¸Šã’</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Alt + â†</kbd> <span>å‰ã®å•é¡Œ</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Alt + â†’</kbd> <span>æ¬¡ã®å•é¡Œ</span>
                            </div>
                            <div class="shortcut-item">
                                <kbd>Ctrl + Enter</kbd> <span>å›ç­”æå‡º</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="row">
        <div class="col-12 text-center">
            <button id="saveSettingsBtn" class="btn btn-success btn-lg">
                <i class="fas fa-save"></i> è¨­å®šã‚’ä¿å­˜
            </button>
        </div>
    </div>
</div>

<script>
// ãƒ¢ãƒã‚¤ãƒ«è¨­å®šç”»é¢ã® JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // è¨­å®šã®èª­ã¿è¾¼ã¿
    loadMobileSettings();
    
    // PWA ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¨­å®š
    setupPWAInstall();
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®æ›´æ–°
    updateOfflineStatus();
    updateConnectionStatus();
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    setupEventListeners();
});

function loadMobileSettings() {
    // éŸ³å£°è¨­å®šã®èª­ã¿è¾¼ã¿
    const savedSettings = localStorage.getItem('rccm_mobile_settings');
    if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        
        if (settings.voiceSettings) {
            document.getElementById('voiceEnabled').checked = settings.voiceSettings.enabled;
            document.getElementById('voiceRate').value = settings.voiceSettings.rate;
            document.getElementById('voicePitch').value = settings.voiceSettings.pitch;
            document.getElementById('voiceVolume').value = settings.voiceSettings.volume;
            
            updateValueDisplays();
        }
        
        if (settings.touchSettings) {
            document.getElementById('swipeThreshold').value = settings.touchSettings.swipe_threshold;
            document.getElementById('longPressDelay').value = settings.touchSettings.long_press_delay;
            
            updateTouchValueDisplays();
        }
        
        if (settings.offlineSettings) {
            document.getElementById('autoSyncEnabled').checked = settings.offlineSettings.auto_sync_enabled;
        }
    }
}

function setupPWAInstall() {
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        const installBtn = document.getElementById('installPWABtn');
        const statusDiv = document.getElementById('pwaStatus');
        const statusText = document.getElementById('pwaStatusText');
        
        installBtn.style.display = 'block';
        statusDiv.className = 'alert alert-success';
        statusText.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æº–å‚™å®Œäº†';
        
        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const choiceResult = await deferredPrompt.userChoice;
                
                if (choiceResult.outcome === 'accepted') {
                    statusText.textContent = 'ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...';
                } else {
                    statusText.textContent = 'ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ';
                }
                
                deferredPrompt = null;
                installBtn.style.display = 'none';
            }
        });
    });
    
    window.addEventListener('appinstalled', () => {
        const statusDiv = document.getElementById('pwaStatus');
        const statusText = document.getElementById('pwaStatusText');
        
        statusDiv.className = 'alert alert-success';
        statusText.textContent = 'ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã—ãŸï¼';
        
        document.getElementById('installPWABtn').style.display = 'none';
    });
}

function updateOfflineStatus() {
    // IndexedDBã‹ã‚‰ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ³ã‚’å–å¾—
    if ('indexedDB' in window) {
        const request = indexedDB.open('RCCMQuestionApp', 1);
        
        request.onsuccess = function(event) {
            const db = event.target.result;
            
            if (db.objectStoreNames.contains('offlineData')) {
                const transaction = db.transaction(['offlineData'], 'readonly');
                const store = transaction.objectStore('offlineData');
                const countRequest = store.count();
                
                countRequest.onsuccess = function() {
                    document.getElementById('offlineSessionCount').textContent = countRequest.result;
                };
            }
        };
    }
    
    // æœ€çµ‚åŒæœŸæ™‚é–“ã®å–å¾—
    fetch('/api/mobile/performance')
        .then(response => response.json())
        .then(data => {
            document.getElementById('offlineDataSize').textContent = data.total_offline_size_mb + ' MB';
            
            if (data.last_sync) {
                const syncDate = new Date(data.last_sync);
                document.getElementById('lastSyncTime').textContent = syncDate.toLocaleString();
            }
        })
        .catch(error => {
            console.error('Performance data fetch failed:', error);
        });
}

function updateConnectionStatus() {
    const statusElement = document.getElementById('connectionStatus');
    
    if (navigator.onLine) {
        statusElement.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
        statusElement.className = 'badge bg-success';
    } else {
        statusElement.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
        statusElement.className = 'badge bg-danger';
    }
    
    window.addEventListener('online', () => {
        statusElement.textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
        statusElement.className = 'badge bg-success';
    });
    
    window.addEventListener('offline', () => {
        statusElement.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
        statusElement.className = 'badge bg-danger';
    });
}

function setupEventListeners() {
    // éŸ³å£°è¨­å®šã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    ['voiceRate', 'voicePitch', 'voiceVolume'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateValueDisplays);
    });
    
    // ã‚¿ãƒƒãƒè¨­å®šã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    ['swipeThreshold', 'longPressDelay'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateTouchValueDisplays);
    });
    
    // ãƒ†ã‚¹ãƒˆèª­ã¿ä¸Šã’
    document.getElementById('testVoiceBtn').addEventListener('click', testVoice);
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ“ä½œ
    document.getElementById('syncOfflineBtn').addEventListener('click', syncOfflineData);
    document.getElementById('clearOfflineBtn').addEventListener('click', clearOfflineData);
    
    // è¨­å®šä¿å­˜
    document.getElementById('saveSettingsBtn').addEventListener('click', saveAllSettings);
}

function updateValueDisplays() {
    document.getElementById('voiceRateValue').textContent = document.getElementById('voiceRate').value;
    document.getElementById('voicePitchValue').textContent = document.getElementById('voicePitch').value;
    document.getElementById('voiceVolumeValue').textContent = document.getElementById('voiceVolume').value;
}

function updateTouchValueDisplays() {
    document.getElementById('swipeThresholdValue').textContent = document.getElementById('swipeThreshold').value;
    document.getElementById('longPressDelayValue').textContent = document.getElementById('longPressDelay').value;
}

function testVoice() {
    if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance('ã“ã‚Œã¯éŸ³å£°èª­ã¿ä¸Šã’ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚RCCMè©¦é¨“å•é¡Œé›†ã§å­¦ç¿’åŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¾ã—ã‚‡ã†ã€‚');
        utterance.rate = parseFloat(document.getElementById('voiceRate').value);
        utterance.pitch = parseFloat(document.getElementById('voicePitch').value);
        utterance.volume = parseFloat(document.getElementById('voiceVolume').value);
        utterance.lang = 'ja-JP';
        
        speechSynthesis.speak(utterance);
    } else {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
    }
}

function syncOfflineData() {
    const btn = document.getElementById('syncOfflineBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæœŸä¸­...';
    
    fetch('/api/mobile/offline/sync', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`åŒæœŸå®Œäº†: ${data.synced_sessions}ä»¶ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åŒæœŸã—ã¾ã—ãŸ`);
            updateOfflineStatus();
        } else {
            alert('åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        alert('åŒæœŸå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        console.error('Sync error:', error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i> ä»Šã™ãåŒæœŸ';
    });
}

function clearOfflineData() {
    if (confirm('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        if ('indexedDB' in window) {
            const request = indexedDB.open('RCCMQuestionApp', 1);
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                
                if (db.objectStoreNames.contains('offlineData')) {
                    const transaction = db.transaction(['offlineData'], 'readwrite');
                    const store = transaction.objectStore('offlineData');
                    
                    store.clear().onsuccess = function() {
                        alert('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                        updateOfflineStatus();
                    };
                }
            };
        }
    }
}

function saveAllSettings() {
    const settings = {
        voiceSettings: {
            enabled: document.getElementById('voiceEnabled').checked,
            rate: parseFloat(document.getElementById('voiceRate').value),
            pitch: parseFloat(document.getElementById('voicePitch').value),
            volume: parseFloat(document.getElementById('voiceVolume').value),
            language: 'ja-JP'
        },
        touchSettings: {
            swipe_threshold: parseInt(document.getElementById('swipeThreshold').value),
            long_press_delay: parseInt(document.getElementById('longPressDelay').value)
        },
        offlineSettings: {
            auto_sync_enabled: document.getElementById('autoSyncEnabled').checked
        }
    };
    
    localStorage.setItem('rccm_mobile_settings', JSON.stringify(settings));
    
    // ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚ä¿å­˜
    Promise.all([
        fetch('/api/mobile/voice/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings.voiceSettings)
        }),
        fetch('/api/mobile/touch/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings.touchSettings)
        })
    ])
    .then(() => {
        alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    })
    .catch(error => {
        console.error('Settings save error:', error);
        alert('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    });
}
</script>

<style>
.pwa-card, .voice-settings-card, .touch-settings-card, .offline-card, .shortcuts-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.feature-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.feature-item i {
    margin-right: 10px;
    width: 20px;
}

.gesture-guide {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.gesture-item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.gesture-icon {
    font-size: 1.5rem;
    margin-right: 15px;
    width: 30px;
}

.gesture-desc strong {
    display: block;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px solid #e9ecef;
}

.shortcut-item:last-child {
    border-bottom: none;
}

kbd {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 2px 6px;
    font-size: 0.8rem;
}

.voice-controls {
    transition: opacity 0.3s ease;
}

.voice-controls.disabled {
    opacity: 0.5;
    pointer-events: none;
}

@media (max-width: 768px) {
    .gesture-item {
        flex-direction: column;
        align-items: flex-start;
        text-align: left;
    }
    
    .gesture-icon {
        margin-bottom: 5px;
    }
    
    .shortcut-item {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>
{% endblock %}