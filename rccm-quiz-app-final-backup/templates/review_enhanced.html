{% extends "base.html" %}
{% block title %}å¾©ç¿’ãƒªã‚¹ãƒˆ | RCCMè©¦é¨“å•é¡Œé›†{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="mb-2"><i class="fas fa-bookmark text-warning me-2"></i>å¾©ç¿’ãƒªã‚¹ãƒˆ</h1>
            <p class="text-muted">é–“é•ãˆãŸå•é¡Œã‚’ç¹°ã‚Šè¿”ã—å­¦ç¿’ã—ã¦å®Œå…¨ã«ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/" class="btn btn-outline-secondary me-2">
                <i class="fas fa-home me-1"></i>ãƒ›ãƒ¼ãƒ 
            </a>
        </div>
    </div>
    
    {% if message %}
    <!-- å¾©ç¿’ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆ -->
    <div class="alert alert-info text-center">
        <div class="mb-3">
            <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
        </div>
        <h4 class="alert-heading">ç´ æ™´ã‚‰ã—ã„ï¼å¾©ç¿’ãƒªã‚¹ãƒˆãŒç©ºã§ã™</h4>
        <p class="mb-3">{{ message }}</p>
        <a href="/exam" class="btn btn-primary btn-lg">
            <i class="fas fa-play me-2"></i>æ–°ã—ã„å•é¡Œã«æŒ‘æˆ¦
        </a>
    </div>
    {% else %}
    
    <!-- ğŸ”¥ ULTRA SYNC IMPROVEMENT 1: æ˜ç¢ºãªé€²æ—è¡¨ç¤º -->
    <div class="alert alert-primary border-0 mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-2">
                    <i class="fas fa-calendar-check me-2"></i>ğŸ¯ ä»Šæ—¥å¾©ç¿’ã™ã¹ãå•é¡Œ: 
                    <span class="badge bg-danger fs-5 ms-2">{{ due_today_count or 0 }}å•</span>
                </h4>
                <p class="mb-0 text-muted">
                    <i class="fas fa-brain me-1"></i>ç§‘å­¦çš„ãªé–“éš”åå¾©ã‚·ã‚¹ãƒ†ãƒ ãŒæœ€é©ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§é¸æŠã—ãŸå•é¡Œã§ã™
                </p>
            </div>
            <div class="col-md-4 text-center">
                {% if due_today_count and due_today_count > 0 %}
                <a href="/exam/review" class="btn btn-success btn-lg w-100">
                    <i class="fas fa-play me-2"></i>å¾©ç¿’é–‹å§‹
                </a>
                {% else %}
                <div class="text-success">
                    <i class="fas fa-check-circle" style="font-size: 2rem;"></i>
                    <div>ä»Šæ—¥ã®å¾©ç¿’å®Œäº†ï¼</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- SRSçµ±è¨ˆæƒ…å ± -->
    {% if show_srs_details and srs_stats %}
    <div class="row mb-4">
        <div class="col-md-3 mb-2">
            <div class="card bg-warning text-dark text-center">
                <div class="card-body p-2">
                    <h4 class="mb-0">{{ srs_stats.total_questions or 0 }}</h4>
                    <small>ç·å¾©ç¿’å•é¡Œ</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card bg-danger text-white text-center">
                <div class="card-body p-2">
                    <h4 class="mb-0">{{ srs_stats.due_now or 0 }}</h4>
                    <small>è¦å¾©ç¿’å•é¡Œ</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card bg-info text-white text-center">
                <div class="card-body p-2">
                    <h4 class="mb-0">{{ srs_stats.in_progress or 0 }}</h4>
                    <small>å­¦ç¿’ä¸­</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-2">
            <div class="card bg-success text-white text-center">
                <div class="card-body p-2">
                    <h4 class="mb-0">{{ srs_stats.mastered or 0 }}</h4>
                    <small>ğŸ† ãƒã‚¹ã‚¿ãƒ¼æ¸ˆã¿</small>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- å¾“æ¥ã®çµ±è¨ˆè¡¨ç¤º -->
    <div class="row mb-4">
        <div class="col-md-6 mx-auto">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <h3 class="mb-0">{{ total_count or 0 }}</h3>
                    <small>å¾©ç¿’å¯¾è±¡å•é¡Œ</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ğŸ”¥ ULTRA SYNC IMPROVEMENT 3: éƒ¨é–€åˆ¥å¾©ç¿’ -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>ğŸ¯ éƒ¨é–€åˆ¥å¼±ç‚¹åˆ†æ</h5>
        </div>
        <div class="card-body">
            {% if department_stats %}
            <div class="row">
                {% for dept, stats in department_stats.items() %}
                <div class="col-md-4 mb-3">
                    <div class="card border-warning">
                        <div class="card-body text-center p-2">
                            <h6 class="card-title text-primary">{{ dept }}</h6>
                            <div class="mb-2">
                                <span class="badge bg-danger fs-6">{{ stats.weak_count }}å•</span>
                                <small class="text-muted d-block">å¼±ç‚¹å•é¡Œ</small>
                            </div>
                            {% if stats.weak_count > 0 %}
                            <a href="/exam/review?department={{ dept }}" class="btn btn-warning btn-sm">
                                <i class="fas fa-target me-1"></i>é›†ä¸­å¾©ç¿’
                            </a>
                            {% else %}
                            <span class="text-success small">âœ… ãƒã‚¹ã‚¿ãƒ¼æ¸ˆã¿</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="text-center mt-3">
                <a href="/exam/review" class="btn btn-success btn-lg px-5">
                    <i class="fas fa-play me-2"></i>å…¨éƒ¨é–€çµ±åˆå¾©ç¿’
                </a>
            </div>
        </div>
    </div>

    <!-- å¾©ç¿’å•é¡Œãƒªã‚¹ãƒˆ -->
    <div class="card">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-bookmark me-2"></i>å¾©ç¿’ãŒå¿…è¦ãªå•é¡Œï¼ˆ{{ total_count }}å•ï¼‰</h5>
            <small class="text-muted">é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ã—ã¦å®Œå…¨ãƒã‚¹ã‚¿ãƒ¼ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†</small>
        </div>
        <div class="card-body">
            {% for question in questions %}
            <div class="review-question-item mb-3 p-3 border rounded shadow-sm {% if question.priority > 50 %}border-danger{% elif question.wrong_count >= 2 %}border-warning{% endif %}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1 me-3">
                        <div class="question-preview mb-2">
                            <span class="badge bg-secondary me-2">å•{{ loop.index }}</span>
                            {% if question.wrong_count >= 3 %}
                            <span class="badge bg-danger me-2">âš ï¸ è¦æ³¨æ„</span>
                            {% elif question.wrong_count >= 2 %}
                            <span class="badge bg-warning text-dark me-2">ğŸ”„ é‡è¦</span>
                            {% endif %}
                            <span class="fw-bold">{{ question.question[:80] }}{% if question.question|length > 80 %}...{% endif %}</span>
                        </div>
                        <div class="question-meta mb-2">
                            {% if question.year %}
                            <span class="badge bg-info text-white me-2">ğŸ“… {{ question.year }}å¹´åº¦</span>
                            {% endif %}
                            {% if question.question_type == 'specialist' %}
                            <span class="badge bg-success me-2">4-2 å°‚é–€ç§‘ç›®</span>
                            {% elif question.question_type == 'basic' %}
                            <span class="badge bg-primary me-2">4-1 åŸºç¤ç§‘ç›®</span>
                            {% endif %}
                        </div>
                        {% if show_srs_details %}
                        <div class="srs-stats">
                            <!-- ğŸ”¥ ULTRA SYNC IMPROVEMENT 2: å­¦ç¿’åŠ¹ç‡ã®å¯è¦–åŒ– -->
                            {% if question.next_review %}
                            <div class="alert alert-info py-1 px-2 mb-2">
                                <small>
                                    <i class="fas fa-clock me-1 text-primary"></i>
                                    <strong>æ¬¡å›å¾©ç¿’äºˆå®š:</strong> 
                                    {% set days_until = question.days_until_review %}
                                    {% if days_until <= 0 %}
                                        <span class="badge bg-danger">ğŸ”¥ ä»Šã™ãå¾©ç¿’</span>
                                    {% elif days_until == 1 %}
                                        <span class="badge bg-warning text-dark">ğŸ“… æ˜æ—¥å¾©ç¿’äºˆå®š</span>
                                    {% elif days_until <= 3 %}
                                        <span class="badge bg-info">ğŸ“… {{ days_until }}æ—¥å¾Œã«å¾©ç¿’äºˆå®š</span>
                                    {% else %}
                                        <span class="badge bg-success">âœ… {{ days_until }}æ—¥å¾Œã«å†å‡ºé¡Œäºˆå®š</span>
                                    {% endif %}
                                </small>
                            </div>
                            {% endif %}
                            <small class="text-muted d-block">
                                <strong>å­¦ç¿’çŠ¶æ³:</strong> 
                                {% if question.total_attempts > 0 %}
                                æ­£è§£{{ question.correct_count }}/{{ question.total_attempts }}å›
                                {% if question.wrong_count > 0 %}
                                (é–“é•ã„{{ question.wrong_count }}å›)
                                {% endif %}
                                {% else %}
                                æœªå­¦ç¿’
                                {% endif %}
                                {% if question.difficulty_level %}
                                | é›£æ˜“åº¦:
                                {% for i in range(1, 11) %}
                                    {% if i <= question.difficulty_level %}ğŸ”´{% else %}âšª{% endif %}
                                {% endfor %}
                                {% endif %}
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="review-action">
                        <a href="/exam?qid={{ question.id }}" class="btn btn-warning btn-sm fw-bold">
                            <i class="fas fa-redo me-1"></i>å†æŒ‘æˆ¦
                        </a>
                        {% if show_srs_details and question.correct_count >= 4 %}
                        <div class="mt-1">
                            <small class="text-success">
                                <i class="fas fa-star"></i> ã‚ã¨1å›æ­£è§£ã§ãƒã‚¹ã‚¿ãƒ¼ï¼
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <!-- ãƒã‚¹ã‚¿ãƒ¼æ¸ˆã¿å•é¡Œã®è¡¨ç¤ºï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
            {% if mastered_questions and mastered_questions|length > 0 %}
            <div class="mt-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <button class="btn btn-link text-white p-0" type="button" data-bs-toggle="collapse" data-bs-target="#masteredQuestions">
                                ğŸ† ãƒã‚¹ã‚¿ãƒ¼æ¸ˆã¿å•é¡Œ ({{ mastered_questions|length }}å•) 
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h6>
                    </div>
                    <div class="collapse" id="masteredQuestions">
                        <div class="card-body">
                            <p class="text-success mb-3">
                                <i class="fas fa-trophy me-2"></i>
                                ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã‚Œã‚‰ã®å•é¡Œã¯5å›é€£ç¶šæ­£è§£ã—ã¦ãƒã‚¹ã‚¿ãƒ¼ãƒ¬ãƒ™ãƒ«ã«åˆ°é”ã—ã¾ã—ãŸã€‚
                            </p>
                            {% for question in mastered_questions %}
                            <div class="mastered-question-item mb-2 p-2 bg-light border rounded">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <span class="badge bg-success me-2">ğŸ†</span>
                                        <span class="fw-bold">{{ question.question[:60] }}{% if question.question|length > 60 %}...{% endif %}</span>
                                        {% if question.year %}
                                        <span class="badge bg-secondary ms-2">{{ question.year }}å¹´åº¦</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-success">
                                        <i class="fas fa-check-circle"></i> {{ question.correct_count }}å›æ­£è§£
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>


<script>
// ã‚·ãƒ³ãƒ—ãƒ«ãªå¾©ç¿’ãƒªã‚¹ãƒˆæ©Ÿèƒ½
</script>

<style>
.review-question-item {
    background: linear-gradient(135deg, #fff8e1, #fffbf0);
    border: 2px solid #ffcc02 !important;
    border-radius: 12px !important;
    transition: all 0.3s ease;
}

.review-question-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 204, 2, 0.2) !important;
    border-color: #f57c00 !important;
}

.question-preview {
    font-size: 1rem;
    line-height: 1.4;
    word-wrap: break-word;
}

.question-meta {
    margin-top: 8px;
}

.question-meta .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
}

.review-action .btn {
    min-width: 90px;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.review-action .btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
}

.card-header.bg-warning {
    border-bottom: 3px solid #f57c00;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .review-question-item {
        padding: 1rem !important;
        margin-bottom: 1rem !important;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .review-action {
        text-align: center;
    }
    
    .review-action .btn {
        width: 100%;
        min-width: auto;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
    }
    
    .question-preview {
        font-size: 1.1rem;
        margin-bottom: 1rem;
    }
    
    .question-meta .badge {
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }
}

@media (max-width: 480px) {
    .review-question-item {
        padding: 0.75rem !important;
    }
    
    .question-preview {
        font-size: 1rem;
    }
    
    .review-action .btn {
        padding: 0.625rem 1.25rem;
        font-size: 0.95rem;
    }
}
</style>
{% endblock %}