{% extends "base.html" %}

{% block title %}AIå¼±ç‚¹åˆ†æ - RCCMè©¦é¨“å•é¡Œé›†{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-brain text-info"></i> AIå¼±ç‚¹åˆ†æ
                    {% if current_department %}
                    <small class="text-muted">- {{ departments[current_department].name }}</small>
                    {% endif %}
                </h2>
                <div>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home"></i> ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- éƒ¨é–€é¸æŠãƒ•ã‚£ãƒ«ã‚¿ -->
    {% if available_departments %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter text-primary"></i> éƒ¨é–€åˆ¥åˆ†æ</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group-wrap">
                        <a href="{{ url_for('ai_analysis') }}" 
                           class="btn {{ 'btn-primary' if not current_department else 'btn-outline-primary' }} mb-2 mr-2">
                            <i class="fas fa-globe"></i> å…¨ä½“åˆ†æ
                        </a>
                        {% for dept_id, dept_info in available_departments.items() %}
                        <a href="{{ url_for('ai_analysis', department=dept_id) }}" 
                           class="btn {{ 'btn-success' if current_department == dept_id else 'btn-outline-success' }} mb-2 mr-2">
                            {{ departments[dept_id].icon }} {{ dept_info.name }}
                            <span class="badge badge-light">{{ dept_info.count }}å•</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% if current_department %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <h6><i class="fas fa-info-circle text-info"></i> {{ departments[current_department].name }}</h6>
                        <p class="mb-0 small text-muted">{{ departments[current_department].description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- åˆ†æä¿¡é ¼åº¦ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <div class="mr-3">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                    <div class="flex-grow-1">
                        <strong>åˆ†æä¿¡é ¼åº¦: {{ "%.0f"|format((analysis.confidence_score or 0) * 100) }}%</strong>
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-info" style="width: {{ (analysis.confidence_score or 0) * 100 }}%"></div>
                        </div>
                        {% if analysis.confidence_score < 0.5 %}
                        <small class="text-muted">ã‚ˆã‚Šæ­£ç¢ºãªåˆ†æã®ãŸã‚ã€ã•ã‚‰ã«å•é¡Œã«æŒ‘æˆ¦ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼±ç‚¹ã‚¨ãƒªã‚¢åˆ†æ -->
    {% if analysis.weak_areas %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-exclamation-triangle text-warning"></i> å¼±ç‚¹ã‚¨ãƒªã‚¢åˆ†æ</h4>
                </div>
                <div class="card-body">
                    {% for category, info in analysis.weak_areas.items() %}
                    <div class="weak-area-item mb-4 p-3 border rounded">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h5 class="mb-1">{{ category }}</h5>
                                <span class="badge badge-{{ 'danger' if info.priority > 0.7 else 'warning' if info.priority > 0.4 else 'info' }}">
                                    å„ªå…ˆåº¦: {{ info.priority|round(2) }}
                                </span>
                            </div>
                            <div class="col-md-6">
                                <div class="progress mb-2">
                                    <div class="progress-bar bg-{{ 'danger' if info.weakness_score > 0.7 else 'warning' if info.weakness_score > 0.4 else 'success' }}" 
                                         style="width: {{ info.weakness_score * 100 }}%"></div>
                                </div>
                                <small class="text-muted">
                                    å¼±ç‚¹åº¦: {{ "%.1f"|format(info.weakness_score * 100) }}% | 
                                    ä¿¡é ¼åº¦: {{ "%.1f"|format(info.confidence * 100) }}%
                                </small>
                            </div>
                            <div class="col-md-3 text-right">
                                <div class="mb-2">
                                    <strong>æ¨å¥¨å­¦ç¿’:</strong>
                                    {% if info.recommended_focus == 'fundamental_review' %}
                                        <span class="badge badge-danger">åŸºç¤å¾©ç¿’</span>
                                    {% elif info.recommended_focus == 'targeted_practice' %}
                                        <span class="badge badge-warning">é‡ç‚¹ç·´ç¿’</span>
                                    {% elif info.recommended_focus == 'speed_improvement' %}
                                        <span class="badge badge-info">é€Ÿåº¦æ”¹å–„</span>
                                    {% else %}
                                        <span class="badge badge-success">å¿œç”¨æŒ‘æˆ¦</span>
                                    {% endif %}
                                </div>
                                {% if info.details %}
                                <small class="text-muted">
                                    æ­£ç­”ç‡: {{ "%.1f"|format(info.details.accuracy * 100) }}%<br>
                                    å¹³å‡æ™‚é–“: {{ "%.1f"|format(info.details.avg_time) }}ç§’
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success text-center">
                <div class="display-4 mb-3">ğŸ‰</div>
                <h4>ç´ æ™´ã‚‰ã—ã„æˆç¸¾ã§ã™ï¼</h4>
                <p>ç¾åœ¨ã€ç‰¹ã«é‡å¤§ãªå¼±ç‚¹ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ç¶™ç¶šçš„ãªå­¦ç¿’ã§æ›´ãªã‚‹å‘ä¸Šã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- RCCMç‰¹åŒ–åˆ†æçµæœ -->
    {% if analysis.department_analysis or analysis.question_type_analysis or analysis.rccm_specific %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-cogs text-info"></i> RCCMç‰¹åŒ–åˆ†æ</h4>
                </div>
                <div class="card-body">
                    <!-- éƒ¨é–€åˆ¥åˆ†æ -->
                    {% if analysis.department_analysis %}
                    <div class="mb-4">
                        <h6><i class="fas fa-building"></i> éƒ¨é–€åˆ¥æˆç¸¾</h6>
                        <div class="row">
                            {% for dept_id, dept_info in analysis.department_analysis.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h6>{{ dept_info.name }}</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <div class="text-primary">æ­£ç­”ç‡: {{ "%.1f"|format(dept_info.accuracy * 100) }}%</div>
                                                <div class="text-muted small">å•é¡Œæ•°: {{ dept_info.total_questions }}å•</div>
                                            </div>
                                            <div class="text-right">
                                                <div class="progress" style="width: 100px; height: 8px;">
                                                    <div class="progress-bar bg-{{ 'success' if dept_info.accuracy > 0.7 else 'warning' if dept_info.accuracy > 0.5 else 'danger' }}" 
                                                         style="width: {{ dept_info.accuracy * 100 }}%"></div>
                                                </div>
                                            </div>
                                        </div>
                                        {% if dept_info.department_specific_insights %}
                                        <div class="mt-2">
                                            {% for insight in dept_info.department_specific_insights[:2] %}
                                            <small class="text-muted d-block">â€¢ {{ insight }}</small>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- å•é¡Œç¨®åˆ¥åˆ†æ -->
                    {% if analysis.question_type_analysis %}
                    <div class="mb-4">
                        <h6><i class="fas fa-layer-group"></i> å•é¡Œç¨®åˆ¥åˆ†æï¼ˆ4-1åŸºç¤ vs 4-2å°‚é–€ï¼‰</h6>
                        <div class="row">
                            {% for type_id, type_info in analysis.question_type_analysis.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-{{ 'warning' if type_id == 'basic' else 'success' }}">
                                    <div class="card-body">
                                        <h6>{{ type_info.name }}</h6>
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <span>æ­£ç­”ç‡:</span>
                                                <strong>{{ "%.1f"|format(type_info.accuracy * 100) }}%</strong>
                                            </div>
                                            <div class="progress mt-1" style="height: 6px;">
                                                <div class="progress-bar bg-{{ 'warning' if type_id == 'basic' else 'success' }}" 
                                                     style="width: {{ type_info.accuracy * 100 }}%"></div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span class="text-muted small">å¹³å‡æ™‚é–“:</span>
                                            <span class="small">{{ "%.1f"|format(type_info.avg_time) }}ç§’</span>
                                        </div>
                                        {% if type_info.learning_recommendation %}
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <small>{{ type_info.learning_recommendation }}</small>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- RCCMè©¦é¨“æº–å‚™åº¦ -->
                    {% if analysis.rccm_specific and analysis.rccm_specific.rccm_readiness %}
                    <div class="mb-4">
                        <h6><i class="fas fa-graduation-cap"></i> RCCMè©¦é¨“æº–å‚™åº¦</h6>
                        {% set readiness = analysis.rccm_specific.rccm_readiness %}
                        <div class="card border-{{ 'success' if readiness.readiness_level == 'exam_ready' else 'warning' if readiness.readiness_level == 'approaching_ready' else 'info' }}">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    {% if readiness.readiness_level == 'exam_ready' %}
                                        <div class="display-4 text-success">ğŸ¯</div>
                                        <h5 class="text-success">è©¦é¨“æº–å‚™å®Œäº†</h5>
                                    {% elif readiness.readiness_level == 'approaching_ready' %}
                                        <div class="display-4 text-warning">ğŸ“ˆ</div>
                                        <h5 class="text-warning">åˆæ ¼ã¾ã§ã‚ã¨ä¸€æ­©</h5>
                                    {% elif readiness.readiness_level == 'needs_improvement' %}
                                        <div class="display-4 text-info">ğŸ“š</div>
                                        <h5 class="text-info">ç¶™ç¶šå­¦ç¿’ãŒå¿…è¦</h5>
                                    {% else %}
                                        <div class="display-4 text-primary">ğŸŒ±</div>
                                        <h5 class="text-primary">å­¦ç¿’é–‹å§‹æ®µéš</h5>
                                    {% endif %}
                                </div>
                                <p class="text-center">{{ readiness.message }}</p>
                                
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="text-muted small">4-1åŸºç¤</div>
                                        <div class="font-weight-bold">{{ "%.1f"|format(readiness.basic_accuracy * 100) }}%</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-muted small">4-2å°‚é–€</div>
                                        <div class="font-weight-bold">{{ "%.1f"|format(readiness.specialist_accuracy * 100) }}%</div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-muted small">ç·åˆ</div>
                                        <div class="font-weight-bold">{{ "%.1f"|format(readiness.overall_accuracy * 100) }}%</div>
                                    </div>
                                </div>

                                {% if readiness.recommended_next_steps %}
                                <div class="mt-3">
                                    <h6>æ¨å¥¨æ¬¡ã‚¹ãƒ†ãƒƒãƒ—:</h6>
                                    <ul class="list-unstyled">
                                        {% for step in readiness.recommended_next_steps %}
                                        <li><i class="fas fa-arrow-right text-primary"></i> {{ step }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- åŸºç¤â†’å°‚é–€ã®ç›¸é–¢åˆ†æ -->
                    {% if analysis.rccm_specific and analysis.rccm_specific.foundation_impact %}
                    <div class="mb-4">
                        <h6><i class="fas fa-link"></i> åŸºç¤â†’å°‚é–€å­¦ç¿’åŠ¹æœ</h6>
                        <div class="row">
                            {% for category, impact in analysis.rccm_specific.foundation_impact.items() %}
                            <div class="col-md-6 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 border rounded">
                                    <span>{{ category }}</span>
                                    <div class="text-right">
                                        <span class="badge badge-{{ 'success' if impact.foundation_strength else 'warning' }}">
                                            åŸºç¤ {{ "%.0f"|format(impact.basic_accuracy * 100) }}%
                                        </span>
                                        <span class="mx-1">â†’</span>
                                        <span class="badge badge-{{ 'success' if impact.specialist_accuracy > 0.6 else 'warning' }}">
                                            å°‚é–€ {{ "%.0f"|format(impact.specialist_accuracy * 100) }}%
                                        </span>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- å­¦ç¿’ãƒ—ãƒ©ãƒ³ -->
    {% if analysis.learning_plan %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-route text-success"></i> å€‹äººå­¦ç¿’ãƒ—ãƒ©ãƒ³</h4>
                </div>
                <div class="card-body">
                    {% set plan = analysis.learning_plan %}
                    
                    {% if plan.primary_focus %}
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0"><i class="fas fa-star"></i> å„ªå…ˆå­¦ç¿’åˆ†é‡</h6>
                                </div>
                                <div class="card-body">
                                    <h5>{{ plan.primary_focus.category }}</h5>
                                    <p><strong>æ¨å¥¨å•é¡Œæ•°:</strong> {{ plan.primary_focus.recommended_questions }}å•/æ—¥</p>
                                    <p><strong>å­¦ç¿’ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:</strong> 
                                        {% if plan.primary_focus.study_approach == 'intensive_study' %}
                                            é›†ä¸­å­¦ç¿’
                                        {% elif plan.primary_focus.study_approach == 'regular_practice' %}
                                            é€šå¸¸ç·´ç¿’
                                        {% else %}
                                            è»½ã„å¾©ç¿’
                                        {% endif %}
                                    </p>
                                    <p><strong>æ”¹å–„äºˆæƒ³æœŸé–“:</strong> {{ plan.primary_focus.expected_improvement_days }}æ—¥</p>
                                </div>
                            </div>
                        </div>
                        
                        {% if plan.secondary_focus %}
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-plus"></i> è£œåŠ©å­¦ç¿’åˆ†é‡</h6>
                                </div>
                                <div class="card-body">
                                    <h5>{{ plan.secondary_focus.category }}</h5>
                                    <p><strong>æ¨å¥¨å•é¡Œæ•°:</strong> {{ plan.secondary_focus.recommended_questions }}å•/æ—¥</p>
                                    <p><strong>ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:</strong> å¾©ç¿’ã¨ç·´ç¿’</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- æ—¥ã€…ã®æ¨å¥¨ -->
                    {% if plan.daily_recommendation %}
                    <div class="alert alert-light border">
                        <h6><i class="fas fa-calendar-day"></i> ä»Šæ—¥ã®æ¨å¥¨å­¦ç¿’</h6>
                        <p class="mb-2"><strong>{{ plan.daily_recommendation.message }}</strong></p>
                        <p class="mb-0">
                            æ¨å¥¨å•é¡Œæ•°: {{ plan.daily_recommendation.recommended_questions }}å• | 
                            é‡ç‚¹åˆ†é‡: {{ plan.daily_recommendation.focus }}
                        </p>
                        {% if plan.daily_recommendation.specific_advice %}
                        <small class="text-muted">{{ plan.daily_recommendation.specific_advice }}</small>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if plan.motivation_message %}
                    <div class="alert alert-success">
                        <i class="fas fa-heart"></i> {{ plan.motivation_message }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ¨å¥¨å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-cogs text-primary"></i> æ¨å¥¨å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>
                                ç¾åœ¨ã®æ¨å¥¨: 
                                <span class="badge badge-primary badge-lg">
                                    {% if recommended_mode == 'foundation' %}
                                        åŸºç¤å›ºã‚ãƒ¢ãƒ¼ãƒ‰
                                    {% elif recommended_mode == 'balanced' %}
                                        ãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰
                                    {% elif recommended_mode == 'challenge' %}
                                        ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰
                                    {% else %}
                                        å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰
                                    {% endif %}
                                </span>
                            </h5>
                            
                            {% set mode_info = learning_modes[recommended_mode] %}
                            <p class="text-muted">
                                å¼±ç‚¹å­¦ç¿’: {{ (mode_info.weak_area_ratio * 100)|int }}% | 
                                æ–°è¦å•é¡Œ: {{ (mode_info.new_question_ratio * 100)|int }}% | 
                                å¾©ç¿’: {{ (mode_info.review_ratio * 100)|int }}%
                            </p>
                            
                            <div class="mt-3">
                                {% for mode, config in learning_modes.items() %}
                                <div class="mode-option {% if mode == recommended_mode %}recommended{% endif %} mb-2 p-2 border rounded">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>
                                                {% if mode == 'foundation' %}
                                                    åŸºç¤å›ºã‚ãƒ¢ãƒ¼ãƒ‰
                                                {% elif mode == 'balanced' %}
                                                    ãƒãƒ©ãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰
                                                {% elif mode == 'challenge' %}
                                                    ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ¢ãƒ¼ãƒ‰
                                                {% else %}
                                                    å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰
                                                {% endif %}
                                            </strong>
                                            {% if mode == recommended_mode %}
                                                <span class="badge badge-success ml-2">æ¨å¥¨</span>
                                            {% endif %}
                                        </div>
                                        <a href="{{ url_for('adaptive_quiz', mode=mode, department=current_department) }}" class="btn btn-sm btn-outline-primary">
                                            ã“ã®ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="mb-3">
                                <i class="fas fa-robot fa-5x text-info"></i>
                            </div>
                            <p class="text-muted">AIãŒã‚ãªãŸã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã€æœ€é©ãªå­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('adaptive_quiz', mode=recommended_mode, department=current_department) }}" class="btn btn-primary btn-lg mr-2">
                <i class="fas fa-brain"></i> AIæ¨å¥¨ãƒ¢ãƒ¼ãƒ‰ã§å­¦ç¿’é–‹å§‹
            </a>
            <a href="{{ url_for('learning_plan') }}" class="btn btn-info btn-lg mr-2">
                <i class="fas fa-calendar-alt"></i> è©³ç´°å­¦ç¿’ãƒ—ãƒ©ãƒ³
            </a>
            <a href="{{ url_for('statistics') }}" class="btn btn-secondary btn-lg">
                <i class="fas fa-chart-bar"></i> è©³ç´°çµ±è¨ˆ
            </a>
        </div>
    </div>
</div>

<style>
.weak-area-item {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transition: all 0.3s ease;
}

.weak-area-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.mode-option {
    transition: all 0.3s ease;
}

.mode-option:hover {
    background-color: #f8f9fa;
}

.mode-option.recommended {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-color: #2196f3 !important;
}

.progress {
    height: 10px;
}

.badge-lg {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
}

@media (max-width: 768px) {
    .fa-5x {
        font-size: 3rem !important;
    }
    
    .weak-area-item .row > div {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}